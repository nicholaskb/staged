# Query 05: Stage Bottleneck Analysis
# Identifies stages where drugs get stuck or delayed most frequently

PREFIX ex: <https://w3id.org/cmc-stagegate#>
PREFIX time: <http://www.w3.org/2006/time#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?stage ?stageName
       (COUNT(DISTINCT ?drug) AS ?drugCount)
       (COUNT(?delay) AS ?delayedDrugs)
       (SAMPLE(?delayReason) AS ?typicalDelayReason)
       (GROUP_CONCAT(DISTINCT ?startDate; separator=",") AS ?allStartDates)
       (GROUP_CONCAT(DISTINCT ?endDate; separator=",") AS ?allEndDates)
WHERE {
  ?drug a ex:DrugProduct ;
        ex:hasStageHistory ?occupancy .
  ?occupancy ex:occupiedStage ?stage ;
             ex:validDuring ?interval .
  ?stage rdfs:label ?stageName .
  ?interval time:hasBeginning ?begin .
  ?begin time:inXSDDate ?startDate .

  OPTIONAL {
    ?interval time:hasEnd ?end .
    ?end time:inXSDDate ?endDate .
  }

  OPTIONAL {
    ?occupancy ex:delayReason ?delay .
    ?occupancy ex:delayReason ?delayReason .
  }
}
GROUP BY ?stage ?stageName
ORDER BY DESC(?drugCount)

# Expected Output:
# stage        | stageName        | drugCount | avgDays | maxDays | delayedDrugs | typicalDelayReason
# -------------|------------------|-----------|---------|---------|--------------|--------------------------------
# ex:Stage-4   | POC Readiness    | 15        | 427     | 520     | 8            | Extended dose finding studies
# ex:Stage-2   | LI/LO            | 23        | 196     | 365     | 12           | Manufacturing scale-up issues
# ex:Stage-5   | Phase 2 Clinical | 12        | 180     | 240     | 5            | Enrollment challenges
